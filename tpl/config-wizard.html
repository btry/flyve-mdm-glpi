<table class="tab_cadre_fixe" cellpadding="5">
	<tbody>
		{% if step == -1 %}
		<tr>
			<th colspan="3" class="">{{ __('Installation wizard',
				'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td class="center" colspan="2">{{ __('Wizard complete', 'flyvemdm') }}<br>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2">
				<p>{{ __('Wizard complete', 'flyvemdm') }}</p>
				<p>{{ __('This wizard will no longer be accessible.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 1 %}
		<tr>
			<th colspan="3" class="">{{ __('Installation wizard', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td class="center" colspan="2">{{ __('Requirements', 'flyvemdm') }}<br>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2">
				<p>{{ __('To setup Flyve MDM please connect to your server with a command line interface. Some operations require a root access.', 'flyvemdm') }}</p>
				<p>{{ __('This wizard will guide you through the steps to setup Flyve MDM.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 100 %}
		<tr>
			<th colspan="3" class="">{{ __('Email notifications', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires email notifications. The following link will open a new tab to the email notifications settings.', 'flyvemdm') }}</p>
				<p><a href="../../../front/notificationmailingsetting.form.php" target="_blank">{{ __('Email notifications', 'flyvemdm' )}}</a></p>
				<p>{{ __('Flyve MDM requires cron job to run automatic actions.', 'flyvemdm') }}</p>
				<p>{{ __('As root in a terminal, execute the following command.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 101 %}
		<tr>
			<th colspan="3" class="">{{ __('REST API', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires REST API enabled. The following link will open a new tab to the REST API setings.', 'flyvemdm') }}</p>
				<p>{{ __('Please enable the following settings:', 'flyvemdm') }}</p>
				<p>{{ __('- Enable Rest API', 'flyvemdm') }}</p>
				<p>{{ __('- Enable login with credentials', 'flyvemdm') }}</p>
				<p>{{ __('- Enable login with external token', 'flyvemdm') }}</p>
				<p>{{ __('- Add an API client leaving empty IPv4 address range, IPv6 address and application token.', 'flyvemdm') }}</p>
				<p><a href="../../../front/config.form.php?forcetab=Config$8" target="_blank">{{ __('API', 'flyvemdm' )}}</a></p>
			</td>
		</tr>
		{% endif %} {% if step == 102 %}
		<tr>
			<th colspan="3" class="">{{ __('REST API', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires cron job to run automatic actions.', 'flyvemdm') }}</p>
				<p>{{ __('As root in a terminal, execute the following command. Adapt www-data to the user running your HTTP server.', 'flyvemdm') }}</p>
				<p>{{ __('crontab -e -u www-data', 'flyvemdm') }}</p>
				<p>{{ __('Add, if missing, the following line. Adapt path to php CLI binary and path to GLPI:', 'flyvemdm') }}</p>
				<p>*/1 * * * * /usr/bin/php /var/www/html/glpi/front/cron.php &amp;>/dev/null</p>
				<p>{{ __('Automatic actions registered in the scheduler of GLPI will run every minute.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 103 %}
		<tr>
			<th colspan="3" class="">{{ __('DBMS access for Mosquitto', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires that Mosquitto has access to your database.', 'flyvemdm') }}</p>
				<p>{{ __('It is recommended to create a dedicated user for Mosquitto alowed to connect only from a specific IP.', 'flyvemdm') }}</p>
				<p>mysql -e "CREATE USER 'mosquitto'@'192.168.1.20' IDENTIFIED BY 'password';"</p>
				<p>{{ __('This user should be able to only SELECT the following tables:', 'flyvemdm') }}</p>
				<p>- glpi_plugin_flyvemdm_mosquittousers</p>
				<p>- glpi_plugin_flyvemdm_mosquittoacls</p>
				<p>mysql -e "GRANT SELECT ON glpi.glpi_plugin_flyvemdm_mosquittousers TO 'mosquitto'@'192.168.0.20';"</p>
				<p>mysql -e "GRANT SELECT ON glpi.glpi_plugin_flyvemdm_mosquittoacls TO 'mosquitto'@'192.168.0.20';"</p>
				<p>{{ __('Create the file', 'flyvemdm') }}/etc/mysql/conf.d/flyvemdm.cnf</p>
				<p>{{ __('Insert the following content, and adapt the bind address to the interface Mosquitto will use to connect to your DBMS.', 'flyvemdm') }}</p>
				<p><textarea disabled="" rows="6" cols="80">[mysqld]
bind-address = 0.0.0.0
</textarea></p>
				<p>{{ __('Restart your DBMS daemon and check it listens to the expected interface.', 'flyvemdm') }}</p>
				<p>{{ __('Check you can login to your DBMD from the IP which will run Mosquitto.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 104 %}
		<tr>
			<th colspan="3" class="">{{ __('Mosquitto', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires a Message queue server.', 'flyvemdm') }}</p>
				<p>{{ __('Prefer a dedicated server or VM for running Mosquitto.', 'flyvemdm') }}</p>
				<p>{{ __('As root in a terminal, execute the following command', 'flyvemdm') }}</p>
				<p>apt-get install mosquitto mosquitto-auth-plug</p>
				<p>{{ __('Create', 'flyvemdm') }}&nbsp;/etc/mosquitto/conf.d/flyvemdm.conf
				   {{ __('Add the following content, adapting your DBMS credentials:', 'flyvemdm') }}</p>
				<p><textarea disabled="" rows="12" cols="80">allow_anonymous false

auth_plugin /usr/local/lib/libmosquitto-auth-plug.so
auth_opt_backends mysql
auth_opt_host backend-server-ip-or-fqdn
auth_opt_port 3306
auth_opt_user database-user
auth_opt_dbname glpi
auth_opt_pass StrongPassword
auth_opt_userquery SELECT password FROM glpi_plugin_flyvemdm_mqttusers WHERE user='%s' AND enabled='1'
auth_opt_aclquery SELECT topic FROM glpi_plugin_flyvemdm_mqttacls a LEFT JOIN glpi_plugin_flyvemdm_mqttusers u ON (a.plugin_flyvemdm_mqttusers_id = u.id) WHERE u.user='%s' AND u.enabled='1' AND (a.access_level & %d)
auth_opt_cacheseconds 300</textarea></p>
			<p>{{ __('Check Mosquitto is listening to port 1883 (insecure).', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 105 %}
		<tr>
			<th colspan="3" class="">{{ __('Mosquitto client for the backend', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Flyve MDM requires to connect to Mosquitto.', 'flyvemdm') }}</p>
				<p>{{ __('For SYSV systems, link the init script in /etc/init.d/', 'flyvemdm') }}</p>
				<p>ln -s /var/www/html/glpi/plugins/flyvemdm/script/service.sh /etc/init.d/flyvemdm</p>
				<p>{{ __('Check the user configured in the script and adapt it if needed.', 'flyvemdm') }}</p>
				<p>update-rc.d flyvemdm defaults</p>
				<p>service flyvemdm start</p>
			</td>
		</tr>
		{% endif %} {% if step == 200 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2">
				<p>{{ __('To handle Apple devices, you need a Apple Developer Enterprise Account or request a MDM customer certificate to an MDM vendor certified by Apple.', 'flyvemdm') }}</p>
				<p>{{ __('Do you want to:', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr>
			<th colspan="3" class="">{{ __('For vendors', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="new_enterprise_account"
				name="apple_certificate" value="create enterprise account">
				<label for="new_enterprise_account">{{
				__('Create Apple Developer Enterprise Account', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="use_enterprise_account"
				name="apple_certificate"
				value="use enterprise account">
				<label for="use_enterprise_account">{{
				__('Request a vendor certificate using your Developer Enterprise Account', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="sign_customer_cert"
				name="apple_certificate"
				value="sign customer certificate">
				<label for="sign_customer_cert">{{
				__('Sign a customer certificate request', 'flyvemdm') }}</label></td>
		</tr>
		<tr>
			<th colspan="3" class="">{{ __('For customers', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="create_customer_certificate"
				name="apple_certificate"
				value="create customer certificate">
				<label for="create_customer_certificate">{{
				__('Request a MDM customer certificate to a vendor', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="use_customer_cert"
				name="apple_certificate"
				value="use customer certificate">
				<label for="use_customer_cert">{{
				__('Use an existing MDM customer certificate', 'flyvemdm') }}</label></td>
		</tr>
		<tr>
			<th colspan="3" class="">{{ __('Skip Apple devices management', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="skip_apple_mdm"
				name="apple_certificate"
				value="skip apple mdm">
				<label for="skip_apple_mdm">{{
				__('I don\'t want to manage Apple devices ', 'flyvemdm') }}</label></td>
		</tr>
		{% endif %} {% if step == 210 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Open the link below to create your Apple Developer Enterprise Account.', 'flyvemdm') }}</p>
				<p>{{ __('Important: enable the checkbox "My organization is a Mobile Device Management vendor"."', 'flyvemdm') }}</p>
				<p>{{ __('You will receive a phone call from Apple for approval. Therefore you may need to wait several days before the account creation completes.', 'flyvemdm') }}</p>
				<p>{{ __('You may need to come back to this wizard later, and continue by using an existing Developer Enterprise Account.', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td><a href="{{ appleEnterpriseDeveloperUrl }}" target="_blank">{{ appleEnterpriseDeveloperUrl }}</a></td>
		</tr>
		{% endif %} {% if step == 220 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management',
				'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Do you want to:', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="generate_csr"
				name="generate_csr" value="generate csr">
				<label for="generate_csr">{{
				__('Generate a key pair and a CSR with the wizard', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="manually_generate_csr"
				name="generate_csr" value="manually generate csr">
				<label for="manually_generate_csr">{{
				__('use OpenSSL CLI to generate the key pair and the CSR', 'flyvemdm') }}</label></td>
		</tr>
		{% endif %} {% if step == 221 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} -
			{{ __('Generate vendor certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Do you want to:', 'flyvemdm') }}</p>
			</td>
		</tr>
		</tr>
		{% include 'config-wizard/applemdm-create-csr.html' %}
		{% endif %} {% if step == 222 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Generate vendor certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Your keys and certificate signing request are ready.', 'flyvemdm') }}</p>
				<p>{{ __('Please, upload your CSR to your Apple Developer Enterprise Account.', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td><a href="{{ appleEnterpriseDeveloperUrl }}" target="_blank">{{ appleEnterpriseDeveloperUrl }}</a></td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="priv_key" disabled>{{ priv_key }}</textarea></td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="pub_key" disabled>{{ pub_key }}</textarea></td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="csr" disabled>{{ csr }}</textarea></td>
		</tr>
		{% endif %} {% if step == 223 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} -
			{{ __('Generate vendor certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('- Generate a key pair.', 'flyvemdm') }}</p>
				<p>{{ __('openssl genrsa -des3 -out vendor-privkey.pem 4096', 'flyvemdm') }}</p>
				<p>{{ __('- Extract the public key.', 'flyvemdm') }}</p>
				<p>{{ __('openssl rsa -pubout -in vendor-privkey.pem -out vendor-pubkey.pem', 'flyvemdm') }}</p>
				<p>{{ __('- Generate the certificate signing request.', 'flyvemdm') }}</p>
				<p>{{ __('openssl req -new -sha512 -key vendor-privkey.pem -out vendor-csr.csr', 'flyvemdm') }}</p>
				<p>{{ __('- Keep in a safe place the keys and the passphrase.', 'flyvemdm') }}</p>
				<p>{{ __('- Upload your CSR to your Apple Developer Enterprise Account.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 230 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} -
			{{ __('Generate customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('Do you want to:', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="generate_csr"
				name="generate_csr" value="generate csr">
				<label for="generate_csr">{{
				__('Generate a key pair and a CSR with the wizard', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="manually_generate_csr"
				name="generate_csr" value="manually generate csr">
				<label for="manually_generate_csr">{{
				__('use OpenSSL CLI to generate the key pair and the CSR', 'flyvemdm') }}</label></td>
		</tr>
		{% endif %} {% if step == 231 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} -
			{{ __('Generate customer certificate', 'flyvemdm') }}</th>
		</tr>
		{% include 'config-wizard/applemdm-create-csr.html' %}
		{% endif %} {% if step == 232 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Generate customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2">
				<p>{{ __('Your keys and certificate signing request are ready.', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="priv_key" disabled>{{ priv_key }}</textarea></td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="pub_key" disabled>{{ pub_key }}</textarea></td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="csr" disabled>{{ csr }}</textarea></td>
		</tr>
		{% endif %} {% if step == 233 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Generate customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr class="tab_bg_1">
			<td>
				<p>{{ __('- Generate a key pair.', 'flyvemdm') }}</p>
				<p>{{ __('openssl genrsa -des3 -out customer-privkey.pem 4096', 'flyvemdm') }}</p>
				<p>{{ __('- Extract the public key.', 'flyvemdm') }}</p>
				<p>{{ __('openssl rsa -pubout -in customer-privkey.pem -out customer-pubkey.pem', 'flyvemdm') }}</p>
				<p>{{ __('- Generate the certificate signing request.', 'flyvemdm') }}</p>
				<p>{{ __('openssl req -new -key customer-privkey.pem -out customer-csr.csr', 'flyvemdm') }}</p>
				<p>{{ __('- Keep in a safe place the keys and the passphrase.', 'flyvemdm') }}</p>
				<p>{{ __('- Request a certificate from your CSR to your MDM vendor.', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %} {% if step == 240 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Sign customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr>
			<td>
				<p>{{ __('These steps will help you to sign a customer certificate signing request with your vendor certificate.', 'flyvemdm') }}</p>
				<p>{{ __('Do you want to:', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="sign_with_wizard"
				name="customer_siging" value="sign csr">
				<label for="sign_with_wizard">{{
				__('Sign a customer CSR with the wizard', 'flyvemdm') }}</label></td>
		</tr>
		<tr class="tab_bg_1">
			<td><input type="radio" id="sign_with_openssl"
				name="customer_siging" value="manually sign csr">
				<label for="sign_with_openssl">{{
				__('Sign a customer CSR with OpenSSL', 'flyvemdm') }}</label></td>
		</tr>
		{% endif %} {% if step == 241 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Sign customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr>
			<td colspan="3">
				<p>{{ __('Please, give the passphrase of the vendor private key to sign the customer CSR:', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
		   <td>{{ __('Private key passphrase', 'flyvemdm') }}</td>
		   <td><input type="password" name="vendor_privkey_passphrase" value=""></td>
		   <td>{{ __('Private key passphrase', 'flyvemdm') }}</td>
		</tr>
		{% endif %} {% if step == 242 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Sign customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr>
			<td colspan="3">
				<p>{{ __('Your customer certificate is ready.', 'flyvemdm') }}</p>
				<p>{{ __('Please, save your CSR to your Apple Developer Enterprise Account.', 'flyvemdm') }}</p>
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td colspan="2"><textarea rows="10" cols="70" name="customer_crt" disabled>{{ customer_crt }}</textarea></td>
		</tr>
		{% endif %} {% if step == 243 %}
		<tr>
			<th colspan="3" class="">{{ __('Apple device management', 'flyvemdm') }} - {{ __('Sign customer certificate', 'flyvemdm') }}</th>
		</tr>
		<tr>
			<td colspan="3">
				<p>{{ __('- Sign the customer certificate with your vendor certificate', 'flyvemdm') }}</p>
				<p>{{ __('openssl sha1 -sign vendor-privkey.pem < ', 'flyvemdm') }}</p>
			</td>
		</tr>
		{% endif %}
		<tr class="tab_bg_1">
			<td class="center" colspan="2">
				<input type="hidden" name="id" value="1" class="submit">
				<input type="hidden" name="config_context" value="flyvemdm">
				<input type="hidden" name="config_class" value="PluginFlyvemdmConfig">
				{% if step > 1 or step == -1 %}
				<input type="submit" name="back" value="{{ __('Back', 'flyvemdm') }}" class="submit">
				&nbsp;&nbsp;
				{% endif %}
				<input type="submit" name="update" value="{{ update }}" class="submit">
			</td>
		</tr>
		<tr class="tab_bg_1">
			<td class="right" colspan="2">
			{{ __('Wizard page:','flyvemdm') }}&nbsp;{{ step }}
			</td>
		</tr>
	</tbody>
</table>
